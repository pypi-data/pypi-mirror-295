(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3111],{91955:function(e,t,n){Promise.resolve().then(n.bind(n,5506))},82697:function(e,t,n){"use strict";n.d(t,{Z:function(){return x}});var s=n(57437),a=n(15238),o=n.n(a),i=n(2265),c=n(89178),r=n(94880),l=n(58485),u=n(16288),h=n(26100),d=n(19666),g=n(50495),m=e=>{let{name:t,avatar:n,link:a,description:o}=e;return(0,s.jsx)("div",{className:"relative group flex",children:(0,s.jsx)(d.pn,{children:(0,s.jsxs)(d.u,{children:[(0,s.jsx)(d.aJ,{asChild:!0,children:(0,s.jsxs)(g.z,{variant:"ghost",className:"flex items-center justify-center",children:[n,(0,s.jsx)("div",{children:t})]})}),(0,s.jsx)(d._v,{children:(0,s.jsxs)("div",{className:"w-80 h-30",children:[(0,s.jsx)("a",{href:a,target:"_blank",rel:"noreferrer",className:"mt-1 ml-2 block no-underline",children:(0,s.jsxs)("div",{className:"flex items-center justify-start gap-2",children:[n,(0,s.jsxs)("div",{className:"mr-2 mt-1 flex justify-center items-center text-sm font-semibold text-gray-800",children:[t,(0,s.jsx)(h.o,{weight:"bold",className:"ml-1"})]})]})}),o&&(0,s.jsx)("p",{className:"mt-2 ml-6 text-sm text-gray-600 line-clamp-2",children:o||"A Khoj agent"})]})})]})})})},f=n(89417),p=n(69591);function x(e){let[t,n]=(0,i.useState)(null),[a,h]=(0,i.useState)(0),[d,g]=(0,i.useState)(!0),x=(0,i.useRef)(null),v=(0,i.useRef)(null),_=(0,i.useRef)(null),[y,j]=(0,i.useState)(null),[b,C]=(0,i.useState)(!1),M=(0,p.IC)();(0,i.useEffect)(()=>{a<2&&((null==t?void 0:t.chat.length)||setTimeout(()=>{w()},500))},[t,a]),(0,i.useEffect)(()=>{if(!d||b)return;let s=new IntersectionObserver(s=>{s[0].isIntersecting&&d&&(C(!0),function(s){if(!d||b)return;let a=s+1,o="";if(e.conversationId)o="/api/chat/history?client=web&conversation_id=".concat(e.conversationId,"&n=").concat(10*a);else{if(!e.publicConversationSlug)return;o="/api/chat/share/history?client=web&public_conversation_slug=".concat(e.publicConversationSlug,"&n=").concat(10*a)}fetch(o).then(e=>e.json()).then(a=>{if(e.setTitle(a.response.slug),a&&a.response&&a.response.chat&&a.response.chat.length>0){if(a.response.chat.length===(null==t?void 0:t.chat.length)){g(!1),C(!1);return}e.setAgent(a.response.agent),n(a.response),s<2&&w(),C(!1)}else{if(a.response.agent&&a.response.conversation_id){let t={chat:[],agent:a.response.agent,conversation_id:a.response.conversation_id,slug:a.response.slug};e.setAgent(a.response.agent),n(t)}g(!1),C(!1)}}).catch(e=>{console.error(e),window.location.href="/"})}(a),h(e=>e+1))},{threshold:1});return _.current&&s.observe(_.current),()=>s.disconnect()},[d,a,b]),(0,i.useEffect)(()=>{g(!0),C(!1),h(0),n(null)},[e.conversationId]),(0,i.useEffect)(()=>{if(e.incomingMessages){let t=e.incomingMessages[e.incomingMessages.length-1];t&&!t.completed&&j(e.incomingMessages.length-1)}N()&&w()},[e.incomingMessages]);let w=()=>{v.current&&v.current.scrollIntoView(!1)},N=()=>{if(!v.current)return!1;let{scrollTop:e,scrollHeight:t,clientHeight:n}=v.current;return e+n>=t-25};return e.conversationId||e.publicConversationSlug?(0,s.jsx)(r.x,{className:"h-[80vh]",children:(0,s.jsx)("div",{ref:x,children:(0,s.jsxs)("div",{className:o().chatHistory,ref:v,children:[(0,s.jsx)("div",{ref:_,style:{height:"1px"},children:b&&(0,s.jsx)(l.l,{message:"Loading Conversation",className:"opacity-50"})}),t&&t.chat&&t.chat.map((e,n)=>(0,s.jsx)(c.Z,{isMobileWidth:M,chatMessage:e,customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500"),isLastMessage:n===t.chat.length-1},"".concat(n,"fullHistory"))),e.incomingMessages&&e.incomingMessages.map((e,n)=>(0,s.jsxs)(i.Fragment,{children:[(0,s.jsx)(c.Z,{isMobileWidth:M,chatMessage:{message:e.rawQuery,context:[],onlineContext:{},created:e.timestamp,by:"you",automationId:""},customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500")},"".concat(n,"outgoing")),e.trainOfThought&&function(e,t,n,a){let i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=e.length-1;return(0,s.jsxs)("div",{className:"".concat(o().trainOfThought," shadow-sm"),children:[!i&&(0,s.jsx)(l.l,{className:"float-right"}),e.map((e,a)=>(0,s.jsx)(c.H,{message:e,primary:a===r&&t&&!i,agentColor:n},"train-".concat(a)))]},a)}(e.trainOfThought,n===y,(null==t?void 0:t.agent.color)||"orange","".concat(n,"trainOfThought"),e.completed),(0,s.jsx)(c.Z,{isMobileWidth:M,chatMessage:{message:e.rawResponse,context:e.context,onlineContext:e.onlineContext,created:e.timestamp,by:"khoj",automationId:"",rawQuery:e.rawQuery},customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500"),isLastMessage:!0},"".concat(n,"incoming"))]},"incomingMessage".concat(n))),e.pendingMessage&&(0,s.jsx)(c.Z,{isMobileWidth:M,chatMessage:{message:e.pendingMessage,context:[],onlineContext:{},created:new Date().getTime().toString(),by:"you",automationId:""},customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500"),isLastMessage:!0},"pendingMessage-".concat(e.pendingMessage.length)),t&&(0,s.jsx)("div",{className:"".concat(o().agentIndicator," pb-4"),children:(0,s.jsx)("div",{className:"relative group mx-2 cursor-pointer",children:(0,s.jsx)(m,{name:t&&t.agent&&t.agent.name?t.agent.name:"Agent",link:t&&t.agent&&t.agent.slug?"/agents?agent=".concat(t.agent.slug):"/agents",avatar:(0,f.T)(t.agent.icon,t.agent.color)||(0,s.jsx)(u.v,{}),description:t&&t.agent&&t.agent.persona?t.agent.persona:""})})})]})})}):null}},5506:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return f}});var s=n(57437),a=n(11930),o=n.n(a),i=n(2265),c=n(48861),r=n(82697),l=n(58485);n(7395);var u=n(69591),h=n(79306),d=n(38423),g=n(9557);function m(e){let[t,n]=(0,i.useState)(""),[a,c]=(0,i.useState)(!1),[l,u]=(0,i.useState)(null),h=e.setQueryToProcess,g=e.streamedMessages;return((0,i.useEffect)(()=>{t&&(c(!0),h(t))},[t,h]),(0,i.useEffect)(()=>{g&&g.length>0&&g[g.length-1].completed?c(!1):n("")},[g]),e.publicConversationSlug||e.conversationId)?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:o().chatBodyFull,children:(0,s.jsx)(r.Z,{publicConversationSlug:e.publicConversationSlug,conversationId:e.conversationId||"",setAgent:u,setTitle:e.setTitle,pendingMessage:a?t:"",incomingMessages:e.streamedMessages})}),(0,s.jsx)("div",{className:"".concat(o().inputBox," shadow-md bg-background align-middle items-center justify-center px-3"),children:(0,s.jsx)(d.Z,{isLoggedIn:e.isLoggedIn,sendMessage:e=>n(e),sendDisabled:a,chatOptionsData:e.chatOptionsData,conversationId:e.conversationId,agentColor:null==l?void 0:l.color,isMobileWidth:e.isMobileWidth,setUploadedFiles:e.setUploadedFiles})})]}):(0,s.jsx)("div",{className:o().suggestions,children:"Whoops, nothing to see here!"})}function f(){let[e,t]=(0,i.useState)(null),[n,a]=(0,i.useState)(!0),[r,d]=(0,i.useState)("Khoj AI - Chat"),[f,p]=(0,i.useState)(void 0),[x,v]=(0,i.useState)([]),[_,y]=(0,i.useState)(""),[j,b]=(0,i.useState)(!1),[C,M]=(0,i.useState)([]),[w,N]=(0,i.useState)(void 0),S=(0,u.k6)(),I=(0,h.G)(),O=(0,u.IC)();async function T(e){if(!e.ok)throw Error(e.statusText);if(!e.body)throw Error("Response body is null");let t=e.body.getReader(),n=new TextDecoder,s="␃\uD83D\uDD1A␗",a="";for(;;){let e;let{done:o,value:i}=await t.read();if(o){y(""),b(!1);break}for(a+=n.decode(i,{stream:!0});-1!==(e=a.indexOf(s));){let t=a.slice(0,e);if(a=a.slice(e+s.length),t){let e=x.find(e=>!e.completed);if(!e){console.error("No current message found");return}(0,g.VK)(t,e),v([...x])}}}}async function B(){if(!_||!f)return;let e="/api/chat?q=".concat(encodeURIComponent(_),"&conversation_id=").concat(f,"&stream=true&client=web");S&&(e+="&region=".concat(S.region,"&country=").concat(S.country,"&city=").concat(S.city,"&timezone=").concat(S.timezone));let t=await fetch(e);try{await T(t)}catch(e){console.log(e)}}return((0,i.useEffect)(()=>{fetch("/api/chat/options").then(e=>e.json()).then(e=>{a(!1),e&&t(e)}).catch(e=>{console.error(e)}),(0,u.EK)(),N(window.location.pathname.split("/").pop()||"")},[]),(0,i.useEffect)(()=>{if(_&&!f){fetch("/api/chat/share/fork?public_conversation_slug=".concat(w),{method:"POST",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{p(e.conversation_id)}).catch(e=>{console.error(e)});return}if(_){let e={rawResponse:"",trainOfThought:[],context:[],onlineContext:{},completed:!1,timestamp:new Date().toISOString(),rawQuery:_||""};v(t=>[...t,e]),b(!0)}},[_,f,w]),(0,i.useEffect)(()=>{j&&B()},[j]),(0,i.useEffect)(()=>{(async()=>{if(f){let e={rawResponse:"",trainOfThought:[],context:[],onlineContext:{},completed:!1,timestamp:new Date().toISOString(),rawQuery:_||""};b(!0),v(t=>[...t,e])}})()},[f,_]),n)?(0,s.jsx)(l.Z,{}):w?(0,s.jsxs)("div",{className:"".concat(o().main," ").concat(o().chatLayout),children:[(0,s.jsx)("title",{children:r}),(0,s.jsx)("div",{className:o().sidePanel,children:(0,s.jsx)(c.Z,{conversationId:null!=f?f:null,uploadedFiles:C,isMobileWidth:O})}),(0,s.jsx)("div",{className:o().chatBox,children:(0,s.jsx)("div",{className:o().chatBoxBody,children:(0,s.jsx)(i.Suspense,{fallback:(0,s.jsx)(l.Z,{}),children:(0,s.jsx)(m,{conversationId:f,streamedMessages:x,setQueryToProcess:y,isLoggedIn:null!==I,publicConversationSlug:w,chatOptionsData:e,setTitle:d,setUploadedFiles:M,isMobileWidth:O})})})})]}):(0,s.jsx)("div",{className:o().suggestions,children:"Whoops, nothing to see here!"})}},15238:function(e){e.exports={chatHistory:"chatHistory_chatHistory__CoaVT",chatLayout:"chatHistory_chatLayout__ABli_",agentIndicator:"chatHistory_agentIndicator__wOU1f",trainOfThought:"chatHistory_trainOfThought__mMWSR"}},11930:function(e){e.exports={main:"sharedChat_main__7Nayy",suggestions:"sharedChat_suggestions__V8kr_",inputBox:"sharedChat_inputBox__wRW5A",chatBodyFull:"sharedChat_chatBodyFull__O1MOv",chatBody:"sharedChat_chatBody__OnHDL",chatLayout:"sharedChat_chatLayout__gutlc",chatBox:"sharedChat_chatBox__PmAPg",titleBar:"sharedChat_titleBar__vOHp_",chatBoxBody:"sharedChat_chatBoxBody__ef2Nl",agentIndicator:"sharedChat_agentIndicator__ORCl4"}}},function(e){e.O(0,[7849,9427,929,3954,9001,3062,743,7071,2614,9693,1603,9417,9178,8423,2971,7023,1744],function(){return e(e.s=91955)}),_N_E=e.O()}]);