var $=Object.defineProperty;var N=(d,s,r)=>s in d?$(d,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):d[s]=r;var v=(d,s,r)=>(N(d,typeof s!="symbol"?s+"":s,r),r);import{D as T,g as D,em as V,d as q,ed as K,c as I,w as n,u as t,e$ as k,o as u,b as i,aF as h,db as Q,cy as w,bK as X,aA as E,cx as Y,bx as O,X as x,ee as C,d3 as P,ec as y,a as G,aR as z,Y as H,cw as j,R as J,bP as M}from"./vue-router.36bc5188.js";import"./gateway.6a3fe533.js";import{a as W,b as Z,g as tt}from"./datetime.1d3e9607.js";import{e as et,E as at,_ as st}from"./ExecutionStatusIcon.vue_vue_type_script_setup_true_lang.4f69ae65.js";import{c as U}from"./string.8a83f3d1.js";import"./tables.d43a3134.js";import{R as it}from"./dayjs.59f03971.js";import{a as B,A as R}from"./router.748a95a3.js";import{A as F}from"./index.87f1e4b3.js";import{A as nt,C as ot}from"./CollapsePanel.d0b757b8.js";import"./popupNotifcation.a7b5eb5c.js";import"./LoadingOutlined.45ad2840.js";import"./record.2cf5df84.js";(function(){try{var d=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},s=new Error().stack;s&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[s]="1e6cd27f-43c0-4153-ac4e-bca481222ffd",d._sentryDebugIdIdentifier="sentry-dbid-1e6cd27f-43c0-4153-ac4e-bca481222ffd")}catch{}})();class rt{constructor(s,r,l,c,b,f){v(this,"state");v(this,"handleFilterChange",()=>{this.state.currentPage.waitingDebounce=!0,this.state.pagination.currentIndex=1,this.debouncedPageRefetch()});v(this,"debouncedPageRefetch",V.exports.debounce(async()=>{await this.fetchPage(),this.state.currentPage.waitingDebounce=!1},500));v(this,"fetchEmptyLogs",()=>{this.state.currentPage.openedExecutionIds.forEach(async s=>{!this.state.currentPage.loadedLogs[s]&&await this.fetchLogs(s)})});this.executionRepository=s,this.buildRepository=r,this.projectId=l,this.state=T({currentPage:{openedExecutionIds:f?[f]:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],loadedLogs:{}},pagination:{currentIndex:1,pageSize:10,totalCount:0,...b},filters:{dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0,...c},filterOptions:{builds:[],stages:[],statuses:et.map(_=>({label:U(_),value:_}))}}),D(()=>this.state.filters.buildId,()=>{this.fetchStageOptions()}),D(this.state.filters,()=>{this.state.currentPage.openedExecutionIds=[],this.handleFilterChange()}),D(this.state.pagination,()=>{this.state.currentPage.openedExecutionIds=[],this.fetchPage()})}async init(){await Promise.all([this.fetchPage(),this.fetchOptions()]),this.fetchEmptyLogs(),this.setupRefetchInterval()}async fetchPage(){var l,c,b,f;this.state.currentPage.loadingExecutions=!0;const{executions:s,totalCount:r}=await this.executionRepository.list({projectId:this.projectId,buildId:this.state.filters.buildId,status:this.state.filters.status,limit:this.state.pagination.pageSize,offset:(this.state.pagination.currentIndex-1)*this.state.pagination.pageSize,stageId:this.state.filters.stageId,startDate:(c=(l=this.state.filters.dateRange)==null?void 0:l[0])==null?void 0:c.toISOString(),endDate:(f=(b=this.state.filters.dateRange)==null?void 0:b[1])==null?void 0:f.toISOString(),search:this.state.filters.search});this.state.currentPage.loadingExecutions=!1,this.state.currentPage.executions=s,this.state.pagination.totalCount=r}async fetchBuildOptions(){const r=(await this.buildRepository.list(this.projectId)).map(l=>({label:`[${l.id.slice(0,8)}] ${l.createdAt.toLocaleString()} ${l.latest?"(Latest)":""}`,value:l.id}));this.state.filterOptions.builds=r}async fetchStageOptions(){var l;const s=await W.get((l=this.state.filters.buildId)!=null?l:this.state.filterOptions.builds[0].value),r=s==null?void 0:s.runtimes.map(c=>({label:c.title,value:c.id}));this.state.filterOptions.stages=r!=null?r:[]}async fetchOptions(){await this.fetchBuildOptions(),await this.fetchStageOptions()}async fetchLogs(s){const r=await this.executionRepository.fetchLogs(this.projectId,s);this.state.currentPage.loadedLogs[s]=r}async setupRefetchInterval(){setTimeout(async()=>{await Promise.all(this.state.currentPage.openedExecutionIds.map(s=>this.fetchLogs(s))),this.setupRefetchInterval()},1e5)}}const lt={style:{width:"100px",height:"100%",display:"flex","align-items":"center","justify-content":"right",gap:"10px"}},dt={key:0,style:{display:"flex",width:"100%","justify-content":"center"}},ut={key:1,style:{"background-color":"#555","border-radius":"5px",padding:"10px",color:"#fff","font-family":"monospace","max-height":"600px",overflow:"auto"}},_t=q({__name:"Logs",setup(d){const s=new at,r=new Z,l=K(),c=l.params.projectId,b=l.query.executionId;function f(){const{stageId:m,buildId:o,status:e,startDate:p,endDate:g}=l.query;return p&&g?{stageId:m,buildId:o,status:e,dateRange:[k(p),k(g)]}:{stageId:m,buildId:o,status:e}}function _(){const{page:m,pageSize:o}=l.query;return{page:m?parseInt(m,10):1,pageSize:o?parseInt(o,10):10}}const L=new rt(s,r,c,f(),_(),b),{state:a}=L;return L.init(),(m,o)=>(u(),I(t(F),{direction:"vertical",style:{width:"100%"}},{default:n(()=>[i(t(Q),null,{default:n(()=>[h("Logs")]),_:1}),i(t(Y),{layout:"vertical"},{default:n(()=>[i(t(B),{gutter:10},{default:n(()=>[i(t(R),{span:12},{default:n(()=>[i(t(w),{label:"Run ID"},{default:n(()=>[i(t(X),{value:t(a).filters.search,"onUpdate:value":o[0]||(o[0]=e=>t(a).filters.search=e),placeholder:"Search by Run ID",style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),i(t(R),{span:12},{default:n(()=>[i(t(w),{label:"Script"},{default:n(()=>[i(t(E),{value:t(a).filters.stageId,"onUpdate:value":o[1]||(o[1]=e=>t(a).filters.stageId=e),options:t(a).filterOptions.stages,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1})]),_:1}),i(t(B),{gutter:10},{default:n(()=>[i(t(R),{span:8},{default:n(()=>[i(t(w),{label:"Date"},{default:n(()=>[i(t(it),{value:t(a).filters.dateRange,"onUpdate:value":o[2]||(o[2]=e=>t(a).filters.dateRange=e),style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),i(t(R),{span:10},{default:n(()=>[i(t(w),{label:"Build"},{default:n(()=>[i(t(E),{value:t(a).filters.buildId,"onUpdate:value":o[3]||(o[3]=e=>t(a).filters.buildId=e),options:t(a).filterOptions.builds,"option-label":"label","option-value":"value",filter:!1,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1}),i(t(R),{span:6},{default:n(()=>[i(t(w),{label:"Status"},{default:n(()=>[i(t(E),{value:t(a).filters.status,"onUpdate:value":o[4]||(o[4]=e=>t(a).filters.status=e),options:t(a).filterOptions.statuses,"option-label":"label","option-value":"value",filter:!1,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1})]),_:1})]),_:1}),t(a).currentPage.loadingExecutions||t(a).currentPage.waitingDebounce?(u(),I(t(O),{key:0,style:{width:"100%"}})):t(a).currentPage.executions&&t(a).currentPage.executions.length>0?(u(),I(t(F),{key:1,direction:"vertical",style:{width:"100%"}},{default:n(()=>[i(t(ot),{"active-key":t(a).currentPage.openedExecutionIds,"onUpdate:activeKey":o[5]||(o[5]=e=>t(a).currentPage.openedExecutionIds=e),bordered:!1,style:{"background-color":"transparent"},onChange:t(L).fetchEmptyLogs},{default:n(()=>[(u(!0),x(z,null,C(t(a).currentPage.executions,e=>(u(),I(t(nt),{key:e.id,style:{"border-radius":"4px","margin-bottom":"10px",border:"0",overflow:"hidden","background-color":"#fff"}},{header:n(()=>[i(t(P),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[h(y(t(tt)(e.createdAt)),1)]),_:2},1024),i(t(P),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[h(" Run ID: "+y(e.id.slice(0,8)),1)]),_:2},1024),i(t(P),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[h(" Build: "+y(e.buildId.slice(0,8)),1)]),_:2},1024),i(t(P),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[h(" Duration: "+y(e.duration_seconds),1)]),_:2},1024),i(t(P),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>{var p,g;return[h(y((g=(p=t(a).filterOptions.stages.find(S=>S.value===e.stageId))==null?void 0:p.label)!=null?g:e.stageId.slice(0,8)),1)]}),_:2},1024)]),extra:n(()=>[G("div",lt,[h(y(t(U)(e.status))+" ",1),i(st,{status:e.status},null,8,["status"])])]),default:n(()=>{var p,g,S;return[t(a).currentPage.loadedLogs[e.id]?(p=t(a).currentPage.loadedLogs[e.id])!=null&&p.entries.length?(u(),x("div",ut,[(u(!0),x(z,null,C((g=t(a).currentPage.loadedLogs[e.id])==null?void 0:g.entries,A=>(u(),x("p",{key:A.createdAt,style:H({margin:0,"white-space":"pre-wrap",color:A.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},y(A.payload.text.trim()),5))),128))])):(S=t(a).currentPage.loadedLogs[e.id])!=null&&S.entries.length?J("",!0):(u(),I(t(j),{key:2})):(u(),x("div",dt,[i(t(O))]))]}),_:2},1024))),128))]),_:1},8,["active-key","onChange"]),i(t(M),{current:t(a).pagination.currentIndex,"onUpdate:current":o[6]||(o[6]=e=>t(a).pagination.currentIndex=e),"page-size":t(a).pagination.pageSize,"onUpdate:pageSize":o[7]||(o[7]=e=>t(a).pagination.pageSize=e),total:t(a).pagination.totalCount,"show-size-changer":""},null,8,["current","page-size","total"])]),_:1})):(u(),I(t(j),{key:2}))]),_:1}))}});export{_t as default};
//# sourceMappingURL=Logs.4d53b7dc.js.map
